<%= render partial: 'shared/nav_menu', locals: { menu_items: [
  { label: 'Danh s√°ch thi·∫øt b·ªã', href: devices_path, active: false },
  { label: @device.name, href: device_path(@device), active: true }
] } %>

<div class="mt-4">
  <!-- Th√¥ng tin thi·∫øt b·ªã -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title text-primary">
        <strong>Thi·∫øt b·ªã: <%= @device.name %></strong>
      </h5>

      <div class="d-flex align-items-center">
        <strong class="me-2">L·∫ßn k·∫øt n·ªëi l·∫ßn cu·ªëi:</strong>
        <span class="text-muted me-3">
          <%= Time.parse(@device_info['last_seen']).strftime('%d/%m/%Y %H:%M:%S') if @device_info['last_seen'].present? %>
        </span>

        <%= button_to "üîÑ L√†m m·ªõi", "/api/devices/refresh_device", method: :post,
              params: { device_id: @device.chip_id },
              class: "btn btn-sm btn-outline-secondary",
              form_class: "d-inline" %>
      </div>
    </div>
  </div>


  <!-- Switch -->
  <% if @device.device_type == "switch" && @device_info&.dig("relays").present? %>
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title text-success">ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã</h5>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="relayTabs" role="tablist">
          <% @device_info['relays'].each_with_index do |relay, index| %>
            <li class="nav-item" role="presentation">
              <a class="nav-link <%= 'active' if index == 0 %>" id="relay-tab-<%= index %>"
                 data-bs-toggle="tab" href="#relay-<%= index %>" role="tab"
                 aria-controls="relay-<%= index %>" aria-selected="<%= index == 0 %>">
                K√™nh <%= index + 1 %>
              </a>
            </li>
          <% end %>
        </ul>

        <!-- Tabs Content -->
        <div class="tab-content" id="relayTabContent">
          <% @device_info['relays'].each_with_index do |relay, index| %>
            <div class="tab-pane fade <%= 'show active' if index == 0 %>" id="relay-<%= index %>"
                 role="tabpanel" aria-labelledby="relay-tab-<%= index %>">
              <%= render 'switchon_form', chip_id: @device.chip_id, relay_index: index %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- DHT -->
  <% if @device.device_type == "dht" %>
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title text-info">Th√¥ng tin c·∫£m bi·∫øn DHT</h5>
        <%= render 'dht_form' %>
      </div>
    </div>
  <% end %>

  <% device_info = @device.device_info.present? ? JSON.parse(@device.device_info) : {} %>

<div>
  <span>üÜî </span>  
  <small class="text-muted"><%= @device.chip_id %></small>
</div>

<% if device_info['build_version'].present? || device_info['app_version'].present? %>
  <div>
    <% if device_info['build_version'].present? %>
      <span>üõ†Ô∏è <small class="text-muted">v<%= device_info['build_version'] %></small></span>
    <% end %>

    <% if device_info['build_version'].present? && device_info['app_version'].present? %>
      &nbsp;&nbsp;|&nbsp;&nbsp;
    <% end %>

    <% if device_info['app_version'].present? %>
      <span>üì± <small class="text-muted">v<%= device_info['app_version'] %></small></span>
    <% end %>
  </div>
<% end %>


  <!-- N√∫t Kh·ªüi ƒë·ªông l·∫°i -->
  <div class="text-center mt-4">
    <%= button_to "üîÅ Kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã", "/api/devices/restart", method: :post,
                  params: { chip_id: @device.chip_id },
                  data: { confirm: "B·∫°n c√≥ ch·∫Øc mu·ªën kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã kh√¥ng?" },
                  class: "btn btn-lg btn-danger px-5 py-2" %>
  </div>

  <!-- N√∫t Thay ƒë·ªïi WiFi -->
  <div class="text-center mt-3">
    <%= button_to "üì∂ Thay ƒë·ªïi WiFi", "/api/devices/reset_wifi", method: :post,
                  params: { chip_id: @device.chip_id },
                  data: { confirm: "Thi·∫øt b·ªã s·∫Ω x√≥a WiFi c≈© v√† chuy·ªÉn sang ch·∫ø ƒë·ªô c·∫•u h√¨nh m·ªõi. B·∫°n c√≥ ch·∫Øc kh√¥ng?" },
                  class: "btn btn-lg btn-warning px-5 py-2" %>
  </div>
</div>
